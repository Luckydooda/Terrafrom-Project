# ğŸ”„ Dynamic Matrix Generation - Complete Guide

## ğŸ“‹ Table of Contents
1. [What is Dynamic Matrix Generation?](#what-is-dynamic-matrix-generation)
2. [Why Do We Need It?](#why-do-we-need-it)
3. [How Does It Work?](#how-does-it-work)
4. [Task 14 Implementation Guide](#task-14-implementation-guide)
5. [Best Practices](#best-practices)

---

## ğŸ¯ What is Dynamic Matrix Generation?

**Dynamic Matrix Generation** creates a matrix strategy **at runtime** based on file contents, API responses, or other dynamic sources. Unlike static matrices defined in YAML, dynamic matrices are generated by a job and passed to another job.

### Simple Analogy
- **Static Matrix**: Hardcoded list (like a printed menu)
- **Dynamic Matrix**: Generated from file/API (like a digital menu that updates)

### Key Features:
- âœ… **Generated at runtime** (not hardcoded)
- âœ… **Based on external sources** (files, APIs, etc.)
- âœ… **Flexible** (add new versions without changing workflow)
- âœ… **Maintainable** (update file, not workflow)

---

## ğŸ” Why Do We Need It?

### 1. **Flexibility** ğŸ”§
- Add new versions without editing workflow
- Update supported versions in one place
- No workflow changes needed

**Example:**
```
âŒ WITHOUT: Edit workflow YAML to add Python 3.12
âœ… WITH: Add "python:3.12" to file â†’ automatically included
```

### 2. **Maintainability** ğŸ› ï¸
- Single source of truth (the file)
- Update versions in one place
- Workflow stays clean

### 3. **Scalability** ğŸ“ˆ
- Easy to add many versions
- No YAML bloat
- Cleaner workflow files

### 4. **External Configuration** ğŸ“„
- Versions defined in config file
- Can be managed separately
- Version control friendly

### 5. **Automation** ğŸ¤–
- Generate matrix from API
- Parse version files
- Dynamic based on conditions

---

## âš™ï¸ How Does It Work?

### Step-by-Step Flow:

```
1. Job 1: Generate Matrix
   - Reads file/API
   - Parses data
   - Outputs JSON matrix
   â†“
2. Job 2: Use Matrix
   - Receives matrix from Job 1
   - Uses matrix strategy
   - Runs for each combination
```

### Visual Flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generate Matrix    â”‚
â”‚  Job                â”‚
â”‚  - Read file        â”‚
â”‚  - Parse versions   â”‚
â”‚  - Output JSON      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Matrix Output:     â”‚
â”‚  {                  â”‚
â”‚    "language":      â”‚
â”‚      ["python",     â”‚
â”‚       "node"],      â”‚
â”‚    "version":       â”‚
â”‚      ["3.9",        â”‚
â”‚       "3.10",       â”‚
â”‚       "3.11"]       â”‚
â”‚  }                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Test Matrix Job    â”‚
â”‚  - Uses matrix      â”‚
â”‚  - Runs 6 jobs:     â”‚
â”‚    python:3.9       â”‚
â”‚    python:3.10      â”‚
â”‚    python:3.11      â”‚
â”‚    node:3.9         â”‚
â”‚    node:3.10        â”‚
â”‚    node:3.11        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Task 14 Implementation Guide

### Requirements Recap:
1. Create `supported-versions.txt` with:
   ```
   python:3.9
   python:3.10
   python:3.11
   node:18
   node:20
   ```
2. Create `.github/workflows/dynamic-matrix.yml`:
   - Job 1: `generate-matrix`
     - Reads `supported-versions.txt`
     - Parses versions
     - Outputs matrix in JSON format
   - Job 2: `test-matrix`
     - Uses matrix from Job 1
     - Sets up correct language/version
     - Runs tests

### Step 1: Create Version File

```txt
# supported-versions.txt
python:3.9
python:3.10
python:3.11
node:18
node:20
```

### Step 2: Create Dynamic Matrix Workflow

```yaml
name: Dynamic Matrix Generation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # Job 1: Generate Matrix
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read supported versions
        id: read-versions
        run: |
          echo "Reading supported-versions.txt..."
          cat supported-versions.txt
      
      - name: Parse and generate matrix
        id: set-matrix
        run: |
          echo "Parsing versions..."
          
          # Initialize arrays
          python_versions=()
          node_versions=()
          
          # Read file line by line
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines and comments
            [[ -z "$line" || "$line" =~ ^#.*$ ]] && continue
            
            # Parse language:version
            if [[ "$line" =~ ^python:(.+)$ ]]; then
              python_versions+=("${BASH_REMATCH[1]}")
            elif [[ "$line" =~ ^node:(.+)$ ]]; then
              node_versions+=("${BASH_REMATCH[1]}")
            fi
          done < supported-versions.txt
          
          # Build JSON matrix
          matrix_json="{"
          matrix_json+="\"language\":["
          
          # Add Python entries
          for version in "${python_versions[@]}"; do
            matrix_json+="{\"language\":\"python\",\"version\":\"$version\"},"
          done
          
          # Add Node entries
          for version in "${node_versions[@]}"; do
            matrix_json+="{\"language\":\"node\",\"version\":\"$version\"},"
          done
          
          # Remove trailing comma and close
          matrix_json="${matrix_json%,}"
          matrix_json+="]}"
          
          echo "Generated matrix: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
      
      - name: Display matrix
        run: |
          echo "Generated matrix:"
          echo '${{ steps.set-matrix.outputs.matrix }}'

  # Job 2: Use Dynamic Matrix
  test-matrix:
    name: Test on ${{ matrix.language }} ${{ matrix.version }}
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display matrix values
        run: |
          echo "Language: ${{ matrix.language }}"
          echo "Version: ${{ matrix.version }}"
      
      - name: Set up Python ${{ matrix.version }}
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.version }}
          cache: 'pip'
      
      - name: Set up Node.js ${{ matrix.version }}
        if: matrix.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          if [ "${{ matrix.language }}" == "python" ]; then
            echo "Installing Python dependencies..."
            pip install -r requirements.txt || echo "No requirements.txt found"
          else
            echo "Installing Node.js dependencies..."
            npm install || echo "No package.json found"
          fi
      
      - name: Run tests
        run: |
          echo "Running tests for ${{ matrix.language }} ${{ matrix.version }}..."
          if [ "${{ matrix.language }}" == "python" ]; then
            python --version
            # pytest || echo "No pytest found"
          else
            node --version
            # npm test || echo "No test script found"
          fi
          echo "âœ… Tests passed for ${{ matrix.language }} ${{ matrix.version }}!"

  # Summary job
  matrix-summary:
    name: Matrix Test Summary
    runs-on: ubuntu-latest
    needs: [generate-matrix, test-matrix]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "## Dynamic Matrix Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Matrix generated from: supported-versions.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Matrix combinations tested:" >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.generate-matrix.outputs.matrix }}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All matrix combinations completed!" >> $GITHUB_STEP_SUMMARY
```

### Alternative: Simpler JSON Generation (Python)

If you prefer a simpler approach using Python:

```yaml
generate-matrix:
  runs-on: ubuntu-latest
  outputs:
    matrix: ${{ steps.set-matrix.outputs.matrix }}
  steps:
    - uses: actions/checkout@v4
    
    - name: Generate matrix
      id: set-matrix
      run: |
        python3 << 'EOF'
        import json
        
        matrix = []
        with open('supported-versions.txt', 'r') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#'):
                    lang, version = line.split(':')
                    matrix.append({
                        "language": lang,
                        "version": version
                    })
        
        result = {"include": matrix}
        print(f"matrix={json.dumps(result)}")
        EOF
      shell: bash
```

---

## âœ… Best Practices

### 1. **Validate Input File**
```yaml
âœ… GOOD:
  - name: Validate file exists
    run: |
      if [ ! -f supported-versions.txt ]; then
        echo "Error: File not found!"
        exit 1
      fi
```

### 2. **Handle Errors**
```yaml
âœ… GOOD:
  - name: Parse versions
    run: |
      # Parse with error handling
      # Validate format
      # Handle empty file
```

### 3. **Use fromJson() Correctly**
```yaml
âœ… GOOD:
  strategy:
    matrix:
      include: ${{ fromJson(needs.job.outputs.matrix) }}

âŒ BAD:
  strategy:
    matrix: ${{ fromJson(...) }}
    # Missing 'include' key
```

### 4. **Format JSON Correctly**
```yaml
âœ… GOOD:
  {"include": [{"language": "python", "version": "3.11"}]}

âŒ BAD:
  [{"language": "python", "version": "3.11"}]
  # Missing "include" wrapper
```

### 5. **Document File Format**
```txt
âœ… GOOD:
  # supported-versions.txt
  # Format: language:version
  # Example: python:3.11
  python:3.9
  python:3.10
```

---

## ğŸ“Š Summary

### What is Dynamic Matrix Generation?
- Matrix generated at runtime
- Based on external sources (files, APIs)
- Flexible and maintainable

### Why Do We Need It?
- Flexibility
- Maintainability
- Scalability
- External configuration
- Automation

### How Does It Work?
1. Job 1 reads file/API
2. Parses and generates JSON matrix
3. Outputs matrix as JSON
4. Job 2 uses `fromJson()` to load matrix
5. Runs for each combination

### Key Syntax:
```yaml
strategy:
  matrix:
    include: ${{ fromJson(needs.job.outputs.matrix) }}
```

---

**Ready to implement Task 14?** Use the examples above as a starting point! ğŸš€

